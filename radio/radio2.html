<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>GospelVoice Radio v6.4-dev</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; background: #f4f4f4; padding: 20px; margin: 0; }
    .player {
      max-width: 400px; margin: 20px auto; background: white;
      border-radius: 12px; padding: 20px; box-shadow: 0 0 12px rgba(0,0,0,0.1);
      position: relative;
    }
    .logo { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; cursor: pointer; }
    .title { font-size: 18px; font-weight: bold; }
    .group { font-size: 14px; color: #666; margin-bottom: 10px; }
    .eq { display: flex; justify-content: center; height: 24px; margin-bottom: 10px; }
    .eq div {
      width: 4px; margin: 0 2px; background: green; opacity: 0;
      animation: eqAnim 1s infinite;
    }
    .eq.playing div { opacity: 1; }
    .eq div:nth-child(2){animation-delay: 0.1s;}
    .eq div:nth-child(3){animation-delay: 0.2s;}
    .eq div:nth-child(4){animation-delay: 0.3s;}
    .eq div:nth-child(5){animation-delay: 0.4s;}
    @keyframes eqAnim {0%,100%{height:20%;}50%{height:100%;}}

    audio { width: 100%; margin-top: 5px; }
    .grid { font-size: 13px; color: #333; margin-top: 10px; }

    button {
      margin-top: 15px; padding: 10px 20px; font-size: 15px;
      border: none; background: #008855; color: white; border-radius: 6px;
      cursor: pointer; transition: transform 0.1s ease, box-shadow 0.1s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    button:active {
      transform: scale(0.97);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
    }

    .marquee {
      margin-top: 20px; background: #006644; color: white; white-space: nowrap;
      overflow: hidden; border-radius: 8px; padding: 6px 0; font-size: 14px;
      box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
    }
    .marquee span {
      display: inline-block; padding-left: 100%;
      animation: scroll-left 15s linear infinite;
    }
    @keyframes scroll-left {
      0%   { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }

    #adminPanel {
      display: none; position: absolute; top: 10px; right: 10px;
      background: #eee; border: 1px solid #ccc; padding: 10px;
      font-size: 13px; z-index: 10; border-radius: 6px;
      max-height: 300px; overflow: auto;
    }
    #adminPanel button {
      display: block; margin: 5px 0;
      width: 100%; font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="player">
    <img id="logo" class="logo" src="" alt="logo">
    <div class="title" id="nowPlaying">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è‚Ä¶</div>
    <div class="group" id="groupName">GospelVoice</div>
    <div class="eq" id="eqAnim"><div></div><div></div><div></div><div></div><div></div></div>
    <audio id="audioPlayer" controls autoplay></audio>
    <div class="grid" id="nextTracks">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ç–µ–Ω—Ç—É ...</div>
    <button onclick="startRadio()">‚ñ∂Ô∏è –ü—ñ–¥–∫–ª—é—á–∏—Ç–∏ / –û–Ω–æ–≤–∏—Ç–∏ –µ—Ñ—ñ—Ä</button>
    <div class="marquee">
      <span>üìª Gospel Voice Radio ‚Äì —Ü—ñ–ª–æ–¥–æ–±–æ–≤–∏–π –µ—Ñ—ñ—Ä üéô –£ –ø—Ä–æ–≥—Ä–∞–º—ñ: –ø—Ä–æ–ø–æ–≤—ñ–¥—ñ, –ø—Å–∞–ª–º–∏, –ø—ñ—Å–Ω—ñ * –¶–µ—Ä–∫–≤–∞ –Ñ–•–ë "–î—ñ–º –Ñ–≤–∞–Ω–≥–µ–ª—ñ—è", –º.–°—É–º–∏, –£–∫—Ä–∞—ó–Ω–∞ *</span>
    </div>

    <div id="adminPanel">
      <b>üîß –ü–∞–Ω–µ–ª—å –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</b><br><br>
      <button onclick="alert(log.join('\n'))">–ü–æ–∫–∞–∑–∞—Ç–∏ –ª–æ–≥</button>
      <button onclick="downloadLog()">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ª–æ–≥-—Ñ–∞–π–ª</button>
      <button onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç–∏ –ª–æ–≥</button>
    </div>
  </div>

  <script>
    const MAIN_PLAYLIST = "https://raw.githubusercontent.com/christian-word/GospelVoice/refs/heads/main/playlist/generated-playlist.json";
    const audio = document.getElementById("audioPlayer");
    const eq = document.getElementById("eqAnim");
    const admin = document.getElementById("adminPanel");
    let currentUrl = "";
    let interval;
    let log = [];

    function logEvent(msg) {
      const time = new Date().toLocaleTimeString();
      const entry = `[${time}] ${msg}`;
      console.log(entry);
      log.push(entry);
      localStorage.setItem("radioLog", JSON.stringify(log));
    }

    function loadLog() {
      const saved = localStorage.getItem("radioLog");
      if (saved) log = JSON.parse(saved);
    }

    function clearLog() {
      log = [];
      localStorage.removeItem("radioLog");
      logEvent("üóëÔ∏è –õ–æ–≥ –æ—á–∏—â–µ–Ω–æ");
    }

    function downloadLog() {
      const blob = new Blob([log.join("\n")], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "radio-log.txt";
      a.click();
      URL.revokeObjectURL(url);
    }

    function updateUI(title, group, image) {
      document.getElementById("nowPlaying").textContent = title;
      document.getElementById("groupName").textContent = group;
      document.getElementById("logo").src = image || "https://via.placeholder.com/80x80?text=üéµ";
    }

    function updateNextTracks(currentIndex, playlist) {
      const grid = document.getElementById("nextTracks");
      let html = "<b>–ù–∞—Å—Ç—É–ø–Ω—ñ —Ç—Ä–µ–∫–∏:</b><br>";
      for (let i = 1; i <= 2; i++) {
        const next = playlist[(currentIndex + i) % playlist.length];
        html += `üéµ ${next.title} (${next.group})<br>`;
      }
      grid.innerHTML = html;
    }

    function isFutureGeneratedAt(generatedAt) {
      return new Date(generatedAt) > new Date();
    }

    function isAfterPlaylistEnd(generatedAt, playlist) {
      const start = new Date(generatedAt).getTime();
      const now = Date.now();
      const totalDuration = playlist.reduce((acc, t) => acc + t.duration, 0) * 1000;
      return now > start + totalDuration;
    }

    async function startRadio() {
      clearInterval(interval);
      try {
        const res = await fetch(MAIN_PLAYLIST);
        const json = await res.json();
        const generatedAt = json.generatedAt;
        const playlist = json.playlist;

        if (isFutureGeneratedAt(generatedAt)) {
          const startTime = new Date(generatedAt).toLocaleTimeString("uk-UA", { hour: '2-digit', minute: '2-digit' });
          updateUI(`üïí –ï—Ñ—ñ—Ä —â–µ –Ω–µ —Ä–æ–∑–ø–æ—á–∞–≤—Å—è ‚Äì –æ—á—ñ–∫—É–π—Ç–µ –ø–æ—á–∞—Ç–∫—É –æ ${startTime}`, "", "https://via.placeholder.com/80x80?text=‚è≥");
          interval = setInterval(startRadio, 15000);
          logEvent("üïí –û—á—ñ–∫—É–≤–∞–Ω–Ω—è —Å—Ç–∞—Ä—Ç—É –µ—Ñ—ñ—Ä—É");
          return;
        }

        if (isAfterPlaylistEnd(generatedAt, playlist)) {
          updateUI("üîö –ï—Ñ—ñ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω–æ", "", "https://via.placeholder.com/80x80?text=üîá");
          document.getElementById("nextTracks").textContent = "–¢—Ä–∞–Ω—Å–ª—è—Ü—ñ—é –∑–∞–≤–µ—Ä—à–µ–Ω–æ.";
          logEvent("üõë –ï—Ñ—ñ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω–æ");
          return;
        }

        const start = Date.parse(generatedAt);
        const now = Date.now();
        let elapsed = Math.floor((now - start) / 1000);
        let total = 0;

        for (let i = 0; i < playlist.length; i++) {
          total += playlist[i].duration;
          if (elapsed < total) {
            const offset = elapsed - (total - playlist[i].duration);
            const url = playlist[i].url.split(";").pop().trim();
            audio.src = url;
            audio.currentTime = offset;
            audio.play().catch(err => {
              logEvent("‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç—Ä–µ–∫—É: " + err.message);
            });
            updateUI(playlist[i].title, playlist[i].group, playlist[i].image);
            updateNextTracks(i, playlist);
            logEvent("‚ñ∂Ô∏è –ï—Ñ—ñ—Ä –∑–∞–ø—É—â–µ–Ω–æ (—Ç—Ä–µ–∫ ‚Ññ" + (i + 1) + ")");
            return;
          }
        }

      } catch (e) {
        console.error("–ü–æ–º–∏–ª–∫–∞:", e);
        updateUI("‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è", "", "https://via.placeholder.com/80x80?text=ERR");
        logEvent("‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è: " + e.message);
      }
    }

    audio.onplay  = () => eq.classList.add("playing");
    audio.onpause = () => eq.classList.remove("playing");

    document.getElementById("logo").addEventListener("dblclick", () => {
      const panel = document.getElementById("adminPanel");
      panel.style.display = panel.style.display === "block" ? "none" : "block";
    });

    loadLog();
  </script>
</body>
</html>
