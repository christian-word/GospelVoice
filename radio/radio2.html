<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>GospelVoice Radio 5.1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; background: #f4f4f4; padding: 20px; text-align: center; }
    .player { max-width: 400px; margin: auto; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 0 12px rgba(0,0,0,0.1); }
    .logo { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; }
    .title { font-size: 18px; font-weight: bold; }
    .group { font-size: 14px; color: #666; margin-bottom: 10px; }
    .eq { display: flex; justify-content: center; height: 24px; margin-bottom: 10px; }
    .eq div { width: 4px; margin: 0 2px; background: green; opacity: 0; animation: eqAnim 1s infinite; }
    .eq.playing div { opacity: 1; }
    .eq div:nth-child(2){animation-delay: 0.1s;}
    .eq div:nth-child(3){animation-delay: 0.2s;}
    .eq div:nth-child(4){animation-delay: 0.3s;}
    .eq div:nth-child(5){animation-delay: 0.4s;}
    @keyframes eqAnim {0%,100%{height:20%;}50%{height:100%;}}
    audio { width: 100%; margin-top: 5px; }
    .countdown { font-size: 13px; color: #666; margin: 6px 0; }
    .grid { font-size: 13px; color: #333; margin-top: 10px; }
    button { margin-top: 15px; padding: 8px 14px; font-size: 14px; border: none; background: #008855; color: white; border-radius: 6px; cursor: pointer; }
  </style>
</head>
<body>
  <div class="player">
    <img id="logo" class="logo" src="" alt="logo">
    <div class="title" id="nowPlaying">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è...</div>
    <div class="group" id="groupName">GospelVoice</div>
    <div class="eq" id="eqAnim"><div></div><div></div><div></div><div></div><div></div></div>
    <audio id="audioPlayer" controls autoplay></audio>
    <div class="countdown" id="countdown"></div>
    <div class="grid" id="nextTracks">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ...</div>
    <button onclick="startRadio()">üîÑ –ó–∞–ø—É—Å–∫ —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—ó</button>
  </div>

  <script>
    const PLAYLIST_URL = "https://raw.githubusercontent.com/christian-word/GospelVoice/refs/heads/main/playlist/generated-playlist.json";
    let allTracks = [];
    let generatedAt = null;
    let currentTrackIndex = -1;
    let expectedTime = 0;
    let intervalId;

    function updateCountdown(sec) {
      const m = Math.floor(sec / 60), s = sec % 60;
      document.getElementById("countdown").textContent = `–î–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Ç—Ä–µ–∫—É: ${m} —Ö–≤ ${s < 10 ? "0" : ""}${s} —Å–µ–∫`;
    }

    function updateNextTracks(index) {
      const grid = document.getElementById("nextTracks");
      let html = "<b>–ù–∞—Å—Ç—É–ø–Ω—ñ —Ç—Ä–µ–∫–∏:</b><br>";
      for (let i = 1; i <= 2; i++) {
        const t = allTracks[(index + i) % allTracks.length];
        html += `üî∏ ${t.title} (${t.group})<br>`;
      }
      grid.innerHTML = html;
    }

    function playTrack(data) {
      const audio = document.getElementById("audioPlayer");
      const eq = document.getElementById("eqAnim");
      expectedTime = data.offset;

      audio.src = data.track.url;
      audio.currentTime = expectedTime;
      audio.play();
      eq.classList.add("playing");

      audio.onpause = () => eq.classList.remove("playing");
      audio.onplay  = () => eq.classList.add("playing");

      audio.ontimeupdate = () => {
        if (Math.abs(audio.currentTime - expectedTime) > 3)
          audio.currentTime = expectedTime;
        expectedTime = audio.currentTime;
      };

      document.getElementById("nowPlaying").textContent = data.track.title;
      document.getElementById("groupName").textContent = data.track.group;
      document.getElementById("logo").src = data.track.image || "https://via.placeholder.com/80x80?text=üéµ";
      updateCountdown(data.remaining);
      updateNextTracks(data.index);
    }

    function getCurrentTrack() {
      const now = Date.now();
      const start = Date.parse(generatedAt);
      const elapsed = Math.floor((now - start) / 1000); // –≤ —Å–µ–∫—É–Ω–¥–∞—Ö

      let total = 0;
      for (let i = 0; ; i++) {
        const track = allTracks[i % allTracks.length];
        total += track.duration;
        if (elapsed < total) {
          return {
            index: i % allTracks.length,
            track: track,
            offset: elapsed - (total - track.duration),
            remaining: total - elapsed
          };
        }
      }
    }

    async function startRadio() {
      const res = await fetch(PLAYLIST_URL);
      const json = await res.json();
      generatedAt = json.generatedAt;
      allTracks = json.playlist;

      const data = getCurrentTrack();
      currentTrackIndex = data.index;
      playTrack(data);

      clearInterval(intervalId);
      intervalId = setInterval(() => {
        const now = getCurrentTrack();
        expectedTime = now.offset;
        if (now.index !== currentTrackIndex) {
          playTrack(now);
          currentTrackIndex = now.index;
        } else {
          updateCountdown(now.remaining);
        }
      }, 1000);
    }
  </script>
</body>
</html>

