<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>GospelVoice Радіо</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      background: #f5f5f5;
    }
    #player-container {
      background: white;
      border-radius: 10px;
      padding: 20px;
      max-width: 500px;
      margin: 0 auto;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    #now-playing {
      font-weight: bold;
      margin: 15px 0;
      min-height: 50px;
    }
    #countdown {
      color: #666;
      margin-bottom: 15px;
    }
    #broadcast-status {
      margin-top: 10px;
      font-size: 14px;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background: #45a049;
    }
    .off-air {
      color: #e74c3c;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="player-container">
    <h2>GospelVoice Радіо</h2>
    <div id="now-playing">Завантаження...</div>
    <div id="countdown"></div>
    <audio id="audio-player" controls></audio>
    <div id="broadcast-status"></div>
    <button id="play-btn">▶ Запустити радіо</button>
  </div>

  <script>
    // Конфигурация
    const PLAYLIST_URL = 'https://raw.githubusercontent.com/christian-word/GospelVoice/main/playlist/playlist-with-durations.json';
    const BROADCAST_HOURS = { start: 7, end: 23 }; // 7:00-23:00

    // Состояние плеера
    let tracks = [];
    let currentTrack = null;
    let isPlaying = false;

    // DOM элементы
    const audioPlayer = document.getElementById('audio-player');
    const playBtn = document.getElementById('play-btn');
    const nowPlayingEl = document.getElementById('now-playing');
    const countdownEl = document.getElementById('countdown');
    const statusEl = document.getElementById('broadcast-status');

    // Загрузка плейлиста
    async function loadPlaylist() {
      try {
        const response = await fetch(PLAYLIST_URL);
        const data = await response.json();
        
        // Собираем все треки в один массив
        return data.categories.reduce((acc, category) => {
          category.tracks.forEach(track => {
            if (track.url && track.url.endsWith('.mp3')) {
              acc.push({
                title: track.title,
                url: track.url,
                duration: track.duration || 180, // 3 минуты по умолчанию
                category: category.name
              });
            }
          });
          return acc;
        }, []);
        
      } catch (error) {
        console.error('Ошибка загрузки плейлиста:', error);
        statusEl.textContent = 'Помилка завантаження плейлиста';
        statusEl.className = 'off-air';
        return [];
      }
    }

    // Проверка времени вещания
    function isBroadcastTime() {
      const hours = new Date().getHours();
      return hours >= BROADCAST_HOURS.start && hours < BROADCAST_HOURS.end;
    }

    // Получение текущего трека
    function getCurrentTrack() {
      if (!tracks.length) return null;
      
      const now = new Date();
      const startOfDay = new Date(
        now.getFullYear(),
        now.getMonth(),
        now.getDate(),
        BROADCAST_HOURS.start,
        0, 0, 0
      );
      
      const secondsPassed = Math.floor((now - startOfDay) / 1000);
      const totalDuration = tracks.reduce((sum, track) => sum + track.duration, 0);
      
      // Если время вне эфира
      if (secondsPassed < 0 || secondsPassed >= totalDuration) {
        return null;
      }
      
      let accumulatedTime = 0;
      for (const track of tracks) {
        if (secondsPassed < accumulatedTime + track.duration) {
          return {
            track,
            position: secondsPassed - accumulatedTime,
            remaining: accumulatedTime + track.duration - secondsPassed
          };
        }
        accumulatedTime += track.duration;
      }
      
      return null;
    }

    // Воспроизведение трека
    function playTrack(trackData) {
      if (!trackData) return;
      
      currentTrack = trackData.track;
      
      // Обновляем интерфейс
      nowPlayingEl.textContent = `${currentTrack.title} (${currentTrack.category})`;
      updateCountdown(trackData.remaining);
      updateBroadcastStatus();
      
      // Устанавливаем источник audio
      if (audioPlayer.src !== currentTrack.url) {
        audioPlayer.src = currentTrack.url;
      }
      
      // Устанавливаем позицию
      audioPlayer.currentTime = trackData.position;
      
      // Пытаемся запустить воспроизведение
      audioPlayer.play()
        .then(() => {
          isPlaying = true;
          playBtn.textContent = '⏸ Пауза';
        })
        .catch(error => {
          console.log('Автовоспроизведение заблокировано:', error);
          statusEl.textContent = 'Нажмите кнопку Play для запуска';
        });
    }

    // Обновление таймера
    function updateCountdown(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      countdownEl.textContent = `До следующего: ${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }

    // Обновление статуса эфира
    function updateBroadcastStatus() {
      const now = new Date();
      const endTime = new Date(
        now.getFullYear(),
        now.getMonth(),
        now.getDate(),
        BROADCAST_HOURS.end,
        0, 0, 0
      );
      
      const remaining = Math.floor((endTime - now) / 1000);
      if (remaining > 0) {
        const hours = Math.floor(remaining / 3600);
        const minutes = Math.floor((remaining % 3600) / 60);
        statusEl.textContent = `Эфир до ${BROADCAST_HOURS.end}:00 (осталось ${hours}ч ${minutes}м)`;
        statusEl.className = '';
      } else {
        statusEl.textContent = 'Эфир завершен на сегодня';
        statusEl.className = 'off-air';
      }
    }

    // Основная функция обновления
    function updatePlayer() {
      if (!isBroadcastTime()) {
        if (isPlaying) {
          audioPlayer.pause();
          isPlaying = false;
          playBtn.textContent = '▶ Запустити радіо';
        }
        statusEl.textContent = `Эфир с ${BROADCAST_HOURS.start}:00 до ${BROADCAST_HOURS.end}:00`;
        statusEl.className = 'off-air';
        return;
      }
      
      const current = getCurrentTrack();
      if (!current) {
        statusEl.textContent = 'Сейчас не время эфира';
        return;
      }
      
      if (!currentTrack || current.track.url !== currentTrack.url) {
        playTrack(current);
      } else {
        updateCountdown(current.remaining);
        updateBroadcastStatus();
      }
    }

    // Инициализация
    async function init() {
      tracks = await loadPlaylist();
      
      if (tracks.length) {
        // Обновляем каждую секунду
        setInterval(updatePlayer, 1000);
        updatePlayer(); // Первое обновление
        
        // Обработчик кнопки play/pause
        playBtn.addEventListener('click', () => {
          if (audioPlayer.paused) {
            updatePlayer();
          } else {
            audioPlayer.pause();
            playBtn.textContent = '▶ Запустити радіо';
          }
        });
      } else {
        statusEl.textContent = 'Не удалось загрузить плейлист';
        statusEl.className = 'off-air';
      }
    }

    // Запуск при загрузке
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>