<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>GospelVoice Radio v5.8</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: sans-serif;
      background: #f4f4f4;
      padding: 20px;
      margin: 0;
    }
    .player {
      max-width: 400px;
      margin: 20px auto;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 12px rgba(0,0,0,0.1);
      position: relative;
    }
    .logo {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 10px;
    }
    .title {
      font-size: 18px;
      font-weight: bold;
    }
    .group {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }
    .eq {
      display: flex;
      justify-content: center;
      height: 24px;
      margin-bottom: 10px;
    }
    .eq div {
      width: 4px;
      margin: 0 2px;
      background: green;
      opacity: 0;
      animation: eqAnim 1s infinite;
    }
    .eq.playing div { opacity: 1; }
    .eq div:nth-child(2){animation-delay: 0.1s;}
    .eq div:nth-child(3){animation-delay: 0.2s;}
    .eq div:nth-child(4){animation-delay: 0.3s;}
    .eq div:nth-child(5){animation-delay: 0.4s;}
    @keyframes eqAnim {0%,100%{height:20%;}50%{height:100%;}}

    audio {
      width: 100%;
      margin-top: 5px;
    }

    .grid {
      font-size: 13px;
      color: #333;
      margin-top: 10px;
    }

    button {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 15px;
      border: none;
      background: #008855;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    button:active {
      transform: scale(0.97);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
    }

    .marquee {
      margin-top: 20px;
      background: #006644;
      color: white;
      white-space: nowrap;
      overflow: hidden;
      border-radius: 8px;
      padding: 6px 0;
      font-size: 14px;
      box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
    }
    .marquee span {
      display: inline-block;
      padding-left: 100%;
      animation: scroll-left 15s linear infinite;
    }
    @keyframes scroll-left {
      0%   { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }
  </style>
</head>
<body>
  <div class="player">
    <img id="logo" class="logo" src="" alt="logo">
    <div class="title" id="nowPlaying">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è‚Ä¶</div>
    <div class="group" id="groupName">GospelVoice</div>

    <div class="eq" id="eqAnim"><div></div><div></div><div></div><div></div><div></div></div>
    <audio id="audioPlayer" controls autoplay></audio>

    <div class="grid" id="nextTracks">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ç–µ–Ω—Ç—É ...</div>
    <button onclick="startRadio()">‚ñ∂Ô∏è –ü—ñ–¥–∫–ª—é—á–∏—Ç–∏ / –û–Ω–æ–≤–∏—Ç–∏ –µ—Ñ—ñ—Ä</button>

    <div class="marquee">
      <span>üìª Gospel Voice Radio ‚Äì —Ü—ñ–ª–æ–¥–æ–±–æ–≤–∏–π –µ—Ñ—ñ—Ä üéô –£ –ø—Ä–æ–≥—Ä–∞–º—ñ: –ø—Ä–æ–ø–æ–≤—ñ–¥—ñ, –ø—Å–∞–ª–º–∏, –ø—ñ—Å–Ω—ñ * –¶–µ—Ä–∫–≤–∞ –Ñ–•–ë "–î—ñ–º –Ñ–≤–∞–Ω–≥–µ–ª—ñ—è", –º.–°—É–º–∏, –£–∫—Ä–∞—ó–Ω–∞ *</span>
    </div>
  </div>

  <audio id="introPlayer" preload="auto" style="display: none;"></audio>

  <script>
    const PLAYLIST_URL = "https://raw.githubusercontent.com/christian-word/GospelVoice/refs/heads/main/playlist/generated-playlist.json";
    const introUrl = "https://christian-word.github.io/GospelVoice/audio/gospel-voice-intro.mp3";

    let allTracks = [];
    let settings = { repetition: true };
    let generatedAt = null;
    let currentTrackIndex = -1;
    let expectedTime = 0;
    let intervalId;
    let introPlayed = false;

    function updateNextTracks(index) {
      const grid = document.getElementById("nextTracks");

      if (index === -1) {
        grid.innerHTML = "<b>üîá –ù–µ–º–∞—î —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—ó</b>";
        return;
      }

      let html = "<b>–¢—Ä–∞–Ω—Å–ª—è—Ü—ñ—è —Ç—Ä–∏–≤–∞—î‚Ä¶</b><br>";
      for (let i = 1; i <= 2; i++) {
        const t = allTracks[(index + i) % allTracks.length];
        html += `üéµ ${t.title} (${t.group})<br>`;
      }
      grid.innerHTML = html;
    }

    function playTrack(data) {
      const audio = document.getElementById("audioPlayer");
      const eq = document.getElementById("eqAnim");
      expectedTime = data.offset;

      audio.src = data.track.url.split(";").pop().trim();
      audio.currentTime = expectedTime;
      audio.play();
      eq.classList.add("playing");

      audio.onpause = () => eq.classList.remove("playing");
      audio.onplay  = () => eq.classList.add("playing");

      audio.ontimeupdate = () => {
        if (Math.abs(audio.currentTime - expectedTime) > 3)
          audio.currentTime = expectedTime;
        expectedTime = audio.currentTime;
      };

      document.getElementById("nowPlaying").textContent = data.track.title;
      document.getElementById("groupName").textContent = data.track.group;
      document.getElementById("logo").src = data.track.image || "https://via.placeholder.com/80x80?text=üéµ";
      updateNextTracks(data.index);
    }

    function getCurrentTrack() {
      const now = Date.now();
      const start = Date.parse(generatedAt);
      const elapsed = Math.floor((now - start) / 1000);

      let total = 0;
      for (let i = 0; i < allTracks.length; i++) {
        total += allTracks[i].duration;
      }

      if (!settings.repetition && elapsed >= total) {
        return { index: -1 }; // —ç—Ñ–∏—Ä –∑–∞–≤–µ—Ä—à–µ–Ω
      }

      let position = settings.repetition ? elapsed % total : elapsed;
      total = 0;

      for (let i = 0; i < allTracks.length; i++) {
        total += allTracks[i].duration;
        if (position < total) {
          return {
            index: i,
            track: allTracks[i],
            offset: position - (total - allTracks[i].duration),
            remaining: total - position
          };
        }
      }
      return { index: -1 };
    }

    async function startRadio() {
      const res = await fetch(PLAYLIST_URL);
      const json = await res.json();
      generatedAt = json.generatedAt;
      allTracks = json.playlist;
      settings = json.settings || { repetition: true };

      const data = getCurrentTrack();
      currentTrackIndex = data.index;

      if (data.index === -1) {
        document.getElementById("nowPlaying").textContent = "–ù–µ–º–∞—î —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—ó";
        updateNextTracks(-1);
        return;
      }

      if (!introPlayed) {
        const intro = document.getElementById("introPlayer");
        intro.src = introUrl;
        intro.volume = 1;
        intro.play().then(() => {
          introPlayed = true;
          setTimeout(() => playTrack(data), intro.duration * 1000 || 6000);
        }).catch(() => {
          playTrack(data);
        });
      } else {
        playTrack(data);
      }

      clearInterval(intervalId);
      intervalId = setInterval(() => {
        const now = getCurrentTrack();
        expectedTime = now.offset;
        if (now.index === -1) {
          document.getElementById("nowPlaying").textContent = "–ù–µ–º–∞—î —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—ó";
          updateNextTracks(-1);
          clearInterval(intervalId);
        } else if (now.index !== currentTrackIndex) {
          playTrack(now);
          currentTrackIndex = now.index;
        }
      }, 1000);
    }
  </script>
</body>
</html>
