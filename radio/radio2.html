<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>GospelVoice Radio v5.6</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; background: #f4f4f4; padding: 20px; text-align: center; }
    .player { max-width: 400px; margin: auto; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 0 12px rgba(0,0,0,0.1); }
    .logo { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; }
    .title { font-size: 18px; font-weight: bold; }
    .group { font-size: 14px; color: #666; margin-bottom: 10px; }
    .eq { display: flex; justify-content: center; height: 24px; margin-bottom: 10px; }
    .eq div { width: 4px; margin: 0 2px; background: green; opacity: 0; animation: eqAnim 1s infinite; }
    .eq.playing div { opacity: 1; }
    .eq div:nth-child(2){animation-delay: 0.1s;}
    .eq div:nth-child(3){animation-delay: 0.2s;}
    .eq div:nth-child(4){animation-delay: 0.3s;}
    .eq div:nth-child(5){animation-delay: 0.4s;}
    @keyframes eqAnim {0%,100%{height:20%;}50%{height:100%;}}
    audio { width: 100%; margin-top: 5px; }
    .countdown, .schedule { font-size: 13px; color: #666; margin: 6px 0; }
    .grid { font-size: 13px; color: #333; margin-top: 10px; }
    button { margin-top: 15px; padding: 8px 14px; font-size: 14px; border: none; background: #008855; color: white; border-radius: 6px; cursor: pointer; }
  </style>
</head>
<body>
  <div class="player">
    <div class="schedule" id="scheduleInfo">üéô –ï—Ñ—ñ—Ä –∑ 07:00 –¥–æ 23:00 (GMT+3)</div>
    <div class="countdown" id="timeStatus">‚è≥ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∞—Å—É...</div>

    <img id="logo" class="logo" src="" alt="logo">
    <div class="title" id="nowPlaying">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è...</div>
    <div class="group" id="groupName">GospelVoice</div>

    <div class="eq" id="eqAnim"><div></div><div></div><div></div><div></div><div></div></div>
    <audio id="audioPlayer" controls autoplay></audio>

    <div class="countdown" id="countdown"></div>
    <div class="grid" id="nextTracks">–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...</div>
    <button onclick="startRadio()">üîÑ –ó–∞–ø—É—Å–∫ / –û–Ω–æ–≤–∏—Ç–∏ –µ—Ñ—ñ—Ä</button>
  </div>

  <script>
    // === GospelVoice Radio v5.6 ===
    const PLAYLIST_URL = "https://raw.githubusercontent.com/christian-word/GospelVoice/refs/heads/main/playlist/generated-playlist.json";
    const introUrl = "https://christian-word.github.io/GospelVoice/audio/gospel-voice-intro.mp3";
    const broadcastStart = 7;
    const broadcastEnd = 23;
    const pausePerNight = 28800;

    let allTracks = [];
    let generatedAt = null;
    let currentTrackIndex = -1;
    let expectedTime = 0;
    let intervalId;
    let introPlayed = false;

    function getLocalHourUTC3(date) {
      return (date.getUTCHours() + 3) % 24;
    }

    function isBroadcastTime() {
      return getLocalHourUTC3(new Date()) >= broadcastStart && getLocalHourUTC3(new Date()) < broadcastEnd;
    }

    function getNightsElapsed() {
      const start = new Date(generatedAt);
      const now = new Date();
      let nights = 0;
      const d = new Date(start);
      while (d < now) {
        const h = getLocalHourUTC3(d);
        if (h === broadcastEnd) nights++;
        d.setHours(d.getHours() + 1);
      }
      return nights;
    }

    function updateScheduleInfo() {
      const now = new Date();
      const utc = now.getUTCHours();
      const min = now.getUTCMinutes();
      const localHour = getLocalHourUTC3(now);
      let msg = "";

      if (localHour < broadcastStart) {
        const remaining = broadcastStart - localHour - 1;
        const minutesLeft = 60 - min;
        msg = `–î–æ –ø–æ—á–∞—Ç–∫—É –µ—Ñ—ñ—Ä—É: ${remaining} –≥–æ–¥ ${minutesLeft < 10 ? "0" : ""}${minutesLeft} —Ö–≤`;
      } else if (localHour >= broadcastEnd) {
        const remaining = 24 - localHour + broadcastStart - 1;
        const minutesLeft = 60 - min;
        msg = `–î–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –µ—Ñ—ñ—Ä—É: ${remaining} –≥–æ–¥ ${minutesLeft < 10 ? "0" : ""}${minutesLeft} —Ö–≤`;
      } else {
        const remaining = broadcastEnd - localHour - 1;
        const minutesLeft = 60 - min;
        msg = `–î–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –µ—Ñ—ñ—Ä—É: ${remaining} –≥–æ–¥ ${minutesLeft < 10 ? "0" : ""}${minutesLeft} —Ö–≤`;
      }

      document.getElementById("timeStatus").textContent = msg;
    }

    function updateCountdown(sec) {
      const m = Math.floor(sec / 60), s = sec % 60;
      document.getElementById("countdown").textContent = `–î–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Ç—Ä–µ–∫—É: ${m} —Ö–≤ ${s < 10 ? "0" : ""}${s} —Å–µ–∫`;
    }

    function updateNextTracks(index) {
      const grid = document.getElementById("nextTracks");
      let html = "<b>–ù–∞—Å—Ç—É–ø–Ω—ñ —Ç—Ä–µ–∫–∏:</b><br>";
      for (let i = 1; i <= 2; i++) {
        const t = allTracks[(index + i) % allTracks.length];
        html += `üî∏ ${t.title} (${t.group})<br>`;
      }
      grid.innerHTML = html;
    }

    function playTrack(data) {
      const audio = document.getElementById("audioPlayer");
      const eq = document.getElementById("eqAnim");
      expectedTime = data.offset;
      let cleanUrl = data.track.url;
      if (cleanUrl.includes(";")) cleanUrl = cleanUrl.split(";")[1].trim();
      audio.src = cleanUrl;
      audio.currentTime = expectedTime;
      audio.play();
      eq.classList.add("playing");

      audio.onpause = () => eq.classList.remove("playing");
      audio.onplay  = () => eq.classList.add("playing");
      audio.ontimeupdate = () => {
        if (Math.abs(audio.currentTime - expectedTime) > 3)
          audio.currentTime = expectedTime;
        expectedTime = audio.currentTime;
      };

      document.getElementById("nowPlaying").textContent = data.track.title;
      document.getElementById("groupName").textContent = data.track.group;
      document.getElementById("logo").src = data.track.image || "https://via.placeholder.com/80x80?text=üéµ";
      updateCountdown(data.remaining);
      updateNextTracks(data.index);
    }

    function getCurrentTrack() {
      const now = Date.now();
      const start = Date.parse(generatedAt);
      const rawElapsed = Math.floor((now - start) / 1000);
      const nights = getNightsElapsed();
      const adjustedElapsed = rawElapsed - (nights * pausePerNight);

      let total = 0;
      for (let i = 0; ; i++) {
        const track = allTracks[i % allTracks.length];
        total += track.duration;
        if (adjustedElapsed < total) {
          return {
            index: i % allTracks.length,
            track: track,
            offset: adjustedElapsed - (total - track.duration),
            remaining: total - adjustedElapsed
          };
        }
      }
    }

    async function startMainRadio() {
      updateScheduleInfo();
      const res = await fetch(PLAYLIST_URL);
      const json = await res.json();
      generatedAt = json.generatedAt;
      allTracks = json.playlist;
      const data = getCurrentTrack();
      currentTrackIndex = data.index;
      playTrack(data);

      clearInterval(intervalId);
      intervalId = setInterval(() => {
        updateScheduleInfo();
        const now = getCurrentTrack();
        expectedTime = now.offset;
        const hour = getLocalHourUTC3(new Date());
        const isWithin = hour >= broadcastStart && hour < broadcastEnd;

        if (now.index !== currentTrackIndex && isWithin) {
          playTrack(now);
          currentTrackIndex = now.index;
        } else if (!isWithin) {
          updateCountdown(0);
        } else {
          updateCountdown(now.remaining);
        }
      }, 1000);
    }

    async function startRadio() {
      updateScheduleInfo();
      if (!introPlayed) {
        introPlayed = true;
        const audio = document.getElementById("audioPlayer");
        const eq = document.getElementById("eqAnim");

        audio.src = introUrl;
        audio.currentTime = 0;
        audio.play();
        eq.classList.add("playing");

        audio.onended = () => {
          eq.classList.remove("playing");
          startMainRadio();
        };

        return;
      }

      startMainRadio();
    }

    setInterval(updateScheduleInfo, 60000);
    updateScheduleInfo();
  </script>
</body>
</html>

