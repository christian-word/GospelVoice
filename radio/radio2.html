<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>Gospel Voice Радіо</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #f5f5f5;
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
    }
    #logo {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      object-fit: cover;
      margin: 15px auto;
      border: 3px solid #4CAF50;
    }
    #nowPlaying {
      font-size: 18px;
      margin: 15px 0;
      font-weight: bold;
    }
    #broadcastInfo {
      color: #666;
      margin-bottom: 15px;
    }
    audio {
      width: 100%;
      margin: 15px 0;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #45a049;
    }
    .off-air {
      color: #e74c3c;
      font-weight: bold;
      margin: 20px 0;
    }
  </style>
</head>
<body>

  <h1>GospelVoice Радіо</h1>
  <img id="logo" src="https://raw.githubusercontent.com/ruyriy/Audio-christ/main/ICO/GroupEast.png" alt="Лого">
  <div id="nowPlaying">Завантаження програми...</div>
  <div id="broadcastInfo"></div>
  <audio id="audioPlayer" controls></audio>
  <div id="statusMessage"></div>
  <button onclick="checkAndPlay()">▶ Слухати</button>

  <script>
    // Конфігурація
    const PLAYLIST_URL = "https://raw.githubusercontent.com/christian-word/GospelVoice/main/playlist/playlist-with-durations.json";
    const BROADCAST_HOURS = { start: 7, end: 23 }; // Ефір з 7:00 до 23:00

    let allTracks = [];
    let currentTrack = null;
    let totalPlaylistDuration = 0;
    let updateInterval;

    // Перевірити чи зараз час ефіру
    function isBroadcastTime() {
      const now = new Date();
      const hours = now.getHours();
      return hours >= BROADCAST_HOURS.start && hours < BROADCAST_HOURS.end;
    }

    // Оновити інформацію про ефір
    function updateBroadcastInfo() {
      const now = new Date();
      const endTime = new Date(
        now.getFullYear(),
        now.getMonth(),
        now.getDate(),
        BROADCAST_HOURS.end,
        0, 0, 0
      );
      
      const remaining = Math.floor((endTime - now) / 1000 / 60); // У хвилинах
      
      if (remaining > 0) {
        document.getElementById("broadcastInfo").innerHTML = `
          <p>Ефір триває до ${BROADCAST_HOURS.end}:00</p>
          <p>Залишилось: ${Math.floor(remaining/60)} год ${remaining%60} хв</p>
        `;
      } else {
        document.getElementById("broadcastInfo").innerHTML = `
          <p class="off-air">Зараз ефір призупинено</p>
          <p>Наступний ефір о ${BROADCAST_HOURS.start}:00</p>
        `;
      }
    }

    // Завантажити плейлист
    async function loadPlaylist() {
      try {
        const response = await fetch(PLAYLIST_URL);
        const data = await response.json();
        const tracks = [];
        
        data.categories.forEach(category => {
          category.tracks.forEach(track => {
            if (track.url && track.url.endsWith(".mp3")) {
              tracks.push({
                title: track.title,
                url: track.url,
                duration: track.duration || 180,
                group: category.name
              });
            }
          });
        });
        
        // Розрахувати загальну тривалість плейлиста
        totalPlaylistDuration = tracks.reduce((sum, track) => sum + track.duration, 0);
        
        return tracks;
      } catch (error) {
        console.error("Помилка завантаження:", error);
        showStatus("Помилка завантаження плейлиста");
        return [];
      }
    }

    // Отримати поточний трек
    function getCurrentTrack(tracks) {
      if (!tracks.length) return null;
      
      const now = new Date();
      const startOfDay = new Date(
        now.getFullYear(),
        now.getMonth(),
        now.getDate(),
        BROADCAST_HOURS.start,
        0, 0, 0
      );
      
      const secondsPassed = Math.floor((now - startOfDay) / 1000);
      
      // Якщо поза ефіром
      if (!isBroadcastTime()) {
        return null;
      }
      
      // Циклічне відтворення плейлиста
      const cyclePosition = secondsPassed % totalPlaylistDuration;
      
      let accumulatedTime = 0;
      for (let i = 0; i < tracks.length; i++) {
        const track = tracks[i];
        if (cyclePosition < accumulatedTime + track.duration) {
          return {
            track: track,
            position: cyclePosition - accumulatedTime,
            remaining: accumulatedTime + track.duration - cyclePosition
          };
        }
        accumulatedTime += track.duration;
      }
      
      return null;
    }

    // Відтворити трек
    function playTrack(trackData) {
      if (!trackData) return;
      
      const audio = document.getElementById("audioPlayer");
      currentTrack = trackData.track;
      
      document.getElementById("nowPlaying").textContent = 
        `Зараз грає: ${currentTrack.title} (${currentTrack.group})`;
      
      audio.src = currentTrack.url;
      audio.currentTime = trackData.position;
      
      // Очистити попередній інтервал
      if (updateInterval) clearInterval(updateInterval);
      
      // Встановити таймер для перевірки наступного треку
      updateInterval = setTimeout(() => {
        checkAndPlay();
      }, trackData.remaining * 1000);
      
      audio.play().catch(e => {
        console.log("Автовідтворення заблоковано:", e);
        showStatus("Натисніть кнопку play для запуску");
      });
    }

    // Показати статус
    function showStatus(message, isError = false) {
      const statusEl = document.getElementById("statusMessage");
      statusEl.textContent = message;
      statusEl.className = isError ? "off-air" : "";
    }

    // Перевірити і запустити
    async function checkAndPlay() {
      if (!allTracks.length) {
        showStatus("Завантаження плейлиста...");
        allTracks = await loadPlaylist();
      }
      
      updateBroadcastInfo();
      
      if (!isBroadcastTime()) {
        showStatus(`Ефір призупинено. Працює з ${BROADCAST_HOURS.start}:00 до ${BROADCAST_HOURS.end}:00`, true);
        if (updateInterval) clearInterval(updateInterval);
        return;
      }
      
      const current = getCurrentTrack(allTracks);
      if (current) {
        playTrack(current);
        showStatus("Радіо працює!");
      } else {
        showStatus("Не вдалося визначити поточний трек", true);
      }
    }

    // Ініціалізація при завантаженні
    window.onload = function() {
      updateBroadcastInfo();
      checkAndPlay();
      
      // Оновлювати інформацію про ефір кожну хвилину
      setInterval(updateBroadcastInfo, 60000);
    };
  </script>
</body>
</html>
