<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ë–∏–±–ª–∏—è (RST) + –ò–ò –ø–æ–º–æ—â–Ω–∏–∫</title>
    <!-- –ó–∞—Å—Ç–∞–≤–∫–∞ –¥–ª—è –í–∞–π–±–µ—Ä–∞ –∏ –¥—Ä—É–≥–∏—Ö —Å–æ—Ü—Å–µ—Ç–µ–π -->
    <meta property="og:image" content="https://raw.githubusercontent.com/ruyriy/Audio-christ/main/ICO/Favicon.png" />
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #333333;
            --primary-color: #3498db;
            --primary-hover: #2980b9;
            --verse-number-color: #e74c3c;
            --highlight-color: #ffeeba;
            --highlight-text-color: #333333;
            --input-border: #dddddd;
            --search-bg: #f8f9fa;
            --result-bg: #f5f5f5;
            --border-radius: 12px;
            --button-padding: 10px 16px;
            --footer-bg: #f1f1f1;
            --footer-text: #666666;
        }

        .dark-mode {
            --bg-color: #1e1e1e;
            --text-color: #f0f0f0;
            --primary-color: #3a7bd5;
            --primary-hover: #2c65b0;
            --verse-number-color: #ff6b6b;
            --highlight-color: #8a6d3b;
            --highlight-text-color: #ffffff;
            --input-border: #444444;
            --search-bg: #2d2d2d;
            --result-bg: #333333;
            --footer-bg: #2a2a2a;
            --footer-text: #aaaaaa;
        }

        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
            line-height: 1.5;
            font-size: 16px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            padding-bottom: 60px;
        }

        .verse {
            margin-bottom: 12px;
            position: relative;
        }

        .verse-number {
            color: var(--verse-number-color);
            font-weight: bold;
            margin-right: 6px;
            font-size: 16px;
        }

        .highlight {
            background-color: var(--highlight-color);
            color: var(--highlight-text-color);
            padding: 1px 3px;
            border-radius: 4px;
        }

        button {
            padding: var(--button-padding);
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 15px;
            margin: 4px;
            transition: background 0.2s, transform 0.1s;
        }

        button:hover {
            background: var(--primary-hover);
        }

        button:active {
            transform: scale(0.98);
        }

        select, input {
            padding: 10px 12px;
            font-size: 15px;
            min-width: 250px;
            margin: 4px;
            border-radius: var(--border-radius);
            border: 1px solid var(--input-border);
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .search-container {
            background: var(--search-bg);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
        }

        .navigation {
            display: flex;
            gap: 8px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        #search-results {
            margin-top: 15px;
        }

        .search-result {
            margin: 12px 0;
            padding: 12px;
            background: var(--result-bg);
            border-left: 4px solid var(--primary-color);
            border-radius: 8px;
            position: relative;
        }

        .search-result-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 22px;
        }

        h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--input-border);
            padding-bottom: 8px;
            font-size: 18px;
            margin-top: 15px;
        }

        .verse-highlight {
            background-color: var(--highlight-color);
            color: var(--highlight-text-color);
            padding: 2px 4px;
            border-radius: 6px;
            display: inline-block;
        }

        .theme-toggle {
            position: fixed;
            bottom: 70px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 100;
        }

        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--footer-bg);
            color: var(--footer-text);
            padding: 10px;
            text-align: center;
            font-size: 12px;
            border-top: 1px solid var(--input-border);
            z-index: 99;
        }

        .footer-content {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å—Ç—Ä–µ–ª–æ–∫ –≤ –∫–æ–Ω—Ü–µ –≥–ª–∞–≤—ã */
        .chapter-end-nav {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            padding: 10px 0;
            border-top: 1px solid var(--input-border);
        }

        .chapter-end-nav button {
            padding: 8px;
            font-size: 18px;
            min-width: 40px;
            height: 40px;
            background: transparent;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .chapter-end-nav button:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .chapter-end-nav .nav-up {
            color: var(--text-color);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —á–∞—Ç–∞ –ò–ò */
        .explain-btn {
            margin-left: 8px;
            padding: 4px 8px;
            font-size: 12px;
            border: none;
            background: var(--primary-color);
            color: white;
            border-radius: 6px;
            cursor: pointer;
        }

        .verse .explain-btn {
            display: none;
        }

        .verse:hover .explain-btn {
            display: inline-block;
        }

        .chat-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .chat-window {
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            background: var(--bg-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-close {
            position: absolute;
            top: 8px; right: 12px;
            font-size: 20px;
            cursor: pointer;
            color: #999;
        }

        #chat-content {
            height: 300px;
            overflow-y: auto;
            border: 1px solid var(--input-border);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            background: var(--search-bg);
            font-size: 14px;
            line-height: 1.4;
            white-space: pre-wrap;
            flex-grow: 1;
        }

        #model-select {
            margin-bottom: 10px;
            padding: 6px;
            background: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--input-border);
            max-width: 100%;
            width: 100%;
            box-sizing: border-box;
        }

        #chat-controls {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            width: 100%;
        }

        #chat-input {
            flex: 1;
            min-width: 200px;
            padding: 8px;
            font-size: 14px;
            border-radius: 6px;
            border: 1px solid var(--input-border);
            background: var(--bg-color);
            color: var(--text-color);
        }

        .chapter-ai-btn {
            margin: 15px 0;
            background: #2ecc71;
        }

        .chapter-ai-btn:hover {
            background: #27ae60;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
                font-size: 15px;
            }
            
            input, select {
                min-width: calc(100% - 20px) !important;
                margin: 4px 0 !important;
                padding: 8px 10px;
            }
            
            button {
                width: calc(50% - 12px);
                margin: 4px 0 !important;
                padding: 8px 10px;
            }
            
            .navigation {
                flex-direction: row;
                justify-content: space-between;
            }
            
            .navigation select {
                width: calc(50% - 10px);
            }
            
            .verse-number {
                font-size: 15px;
            }
            
            .search-container {
                padding: 12px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            h2 {
                font-size: 17px;
            }
            
            .theme-toggle {
                width: 40px;
                height: 40px;
                font-size: 18px;
                bottom: 60px;
                right: 15px;
            }
            
            .footer {
                padding: 8px;
                font-size: 11px;
            }

            /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è —Å—Ç—Ä–µ–ª–æ–∫ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
            .chapter-end-nav button {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è —á–∞—Ç–∞ */
            .chat-window {
                width: 95%;
                padding: 15px;
            }

            #chat-controls {
                flex-direction: column;
            }

            #chat-input {
                width: 100%;
            }

            .search-result-actions {
                flex-direction: column;
            }

            .search-result-actions button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <h1>–ë–∏–±–ª–∏—è (—Å–∏–Ω–æ–¥–∞–ª—å–Ω–∏–π) + –ò–ò –ø–æ–º–æ—â–Ω–∏–∫</h1>
    
    <!-- –ü–æ–∏—Å–∫ -->
    <div class="search-container">
        <input type="text" id="search-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞...">
        <button id="search-btn">–ò—Å–∫–∞—Ç—å</button>
        <button id="reset-btn">–°–±—Ä–æ—Å–∏—Ç—å</button>
        <div id="search-results"></div>
    </div>
    
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="navigation">
        <select id="book-select"></select>
        <select id="chapter-select"></select>
        <button id="nav-prev">–ù–∞–∑–∞–¥</button>
        <button id="nav-next">–í–ø–µ—Ä—ë–¥</button>
    </div>
    
    <!-- –¢–µ–∫—Å—Ç –≥–ª–∞–≤—ã -->
    <h2 id="current-title"></h2>
    <button id="chapter-ai-btn" class="chapter-ai-btn">–°–ø—Ä–æ—Å–∏—Ç—å –ò–ò –æ –≥–ª–∞–≤–µ</button>
    <div id="verses-container"></div>

    <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã -->
    <button class="theme-toggle" id="theme-toggle">üåì</button>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ –ò–ò -->
    <div id="chat-modal" class="chat-modal" style="display:none">
        <div class="chat-window">
            <div class="chat-close" onclick="closeChat()">&times;</div>
            <select id="model-select"></select>
            <div id="chat-content">–û–∂–∏–¥–∞–µ–º –≤–æ–ø—Ä–æ—Å...</div>
            <div id="chat-controls">
                <input type="text" id="chat-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å...">
                <button onclick="sendChat()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                <button onclick="resendLastMessage()">–ü–µ—Ä–µ—Å–ø—Ä–æ—Å–∏—Ç—å</button>
                <button onclick="resetChat()">–°–±—Ä–æ—Å–∏—Ç—å –¥–∏–∞–ª–æ–≥</button>
            </div>
        </div>
    </div>

    <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å (—Ñ—É—Ç–µ—Ä) -->
    <div class="footer">
        <div class="footer-content">
            <div>–º. –°—É–º–∏, –≤–µ—Ä—Å—ñ—è –∑–±—ñ—Ä–∫–∏ 1.0</div>
            <div>¬© 2025 —Ä.</div>
        </div>
    </div>

<script>
    // –î–∞–Ω–Ω—ã–µ
    let bibleData = null;
    let currentBookId = parseInt(localStorage.getItem('lastBook')) || 1;
    let currentChapterId = parseInt(localStorage.getItem('lastChapter')) || 1;
    let darkMode = false;
    let chatHistory = [];
    let lastUserMessage = '';
    
    // –ù–∞–∑–≤–∞–Ω–∏—è –∫–Ω–∏–≥
    const bookNames = {
        1: "–ë—ã—Ç–∏–µ", 2: "–ò—Å—Ö–æ–¥", 3: "–õ–µ–≤–∏—Ç", 4: "–ß–∏—Å–ª–∞", 5: "–í—Ç–æ—Ä–æ–∑–∞–∫–æ–Ω–∏–µ",
        6: "–ò–∏—Å—É—Å –ù–∞–≤–∏–Ω", 7: "–°—É–¥—å–∏", 8: "–†—É—Ñ—å", 9: "1 –¶–∞—Ä—Å—Ç–≤", 10: "2 –¶–∞—Ä—Å—Ç–≤",
        11: "3 –¶–∞—Ä—Å—Ç–≤", 12: "4 –¶–∞—Ä—Å—Ç–≤", 13: "1 –ü–∞—Ä–∞–ª–∏–ø–æ–º–µ–Ω–æ–Ω", 14: "2 –ü–∞—Ä–∞–ª–∏–ø–æ–º–µ–Ω–æ–Ω",
        15: "–ï–∑–¥—Ä–∞", 16: "–ù–µ–µ–º–∏—è", 17: "–ï—Å—Ñ–∏—Ä—å", 18: "–ò–æ–≤", 19: "–ü—Å–∞–ª—Ç–∏—Ä—å",
        20: "–ü—Ä–∏—Ç—á–∏", 21: "–ï–∫–∫–ª–µ—Å–∏–∞—Å—Ç", 22: "–ü–µ—Å–Ω—è –ü–µ—Å–Ω–µ–π", 23: "–ò—Å–∞–∏—è",
        24: "–ò–µ—Ä–µ–º–∏—è", 25: "–ü–ª–∞—á –ò–µ—Ä–µ–º–∏–∏", 26: "–ò–µ–∑–µ–∫–∏–∏–ª—å", 27: "–î–∞–Ω–∏–∏–ª",
        28: "–û—Å–∏—è", 29: "–ò–æ–∏–ª—å", 30: "–ê–º–æ—Å", 31: "–ê–≤–¥–∏–π", 32: "–ò–æ–Ω–∞",
        33: "–ú–∏—Ö–µ–π", 34: "–ù–∞—É–º", 35: "–ê–≤–≤–∞–∫—É–º", 36: "–°–æ—Ñ–æ–Ω–∏—è", 37: "–ê–≥–≥–µ–π",
        38: "–ó–∞—Ö–∞—Ä–∏—è", 39: "–ú–∞–ª–∞—Ö–∏—è", 40: "–û—Ç –ú–∞—Ç—Ñ–µ—è", 41: "–û—Ç –ú–∞—Ä–∫–∞",
        42: "–û—Ç –õ—É–∫–∏", 43: "–û—Ç –ò–æ–∞–Ω–Ω–∞", 44: "–î–µ—è–Ω–∏—è", 45: "–ò–∞–∫–æ–≤–∞",
        46: "1 –ü–µ—Ç—Ä–∞", 47: "2 –ü–µ—Ç—Ä–∞", 48: "1 –ò–æ–∞–Ω–Ω–∞", 49: "2 –ò–æ–∞–Ω–Ω–∞",
        50: "3 –ò–æ–∞–Ω–Ω–∞", 51: "–ò—É–¥—ã", 52: "–†–∏–º–ª—è–Ω–∞–º", 53: "1 –ö–æ—Ä–∏–Ω—Ñ—è–Ω–∞–º",
        54: "2 –ö–æ—Ä–∏–Ω—Ñ—è–Ω–∞–º", 55: "–ì–∞–ª–∞—Ç–∞–º", 56: "–ï—Ñ–µ—Å—è–Ω–∞–º", 57: "–§–∏–ª–∏–ø–ø–∏–π—Ü–∞–º",
        58: "–ö–æ–ª–æ—Å—Å—è–Ω–∞–º", 59: "1 –§–µ—Å—Å–∞–ª–æ–Ω–∏–∫–∏–π—Ü–∞–º", 60: "2 –§–µ—Å—Å–∞–ª–æ–Ω–∏–∫–∏–π—Ü–∞–º",
        61: "1 –¢–∏–º–æ—Ñ–µ—é", 62: "2 –¢–∏–º–æ—Ñ–µ—é", 63: "–¢–∏—Ç—É", 64: "–§–∏–ª–∏–º–æ–Ω—É",
        65: "–ï–≤—Ä–µ—è–º", 66: "–û—Ç–∫—Ä–æ–≤–µ–Ω–∏–µ"
    };
    
    // API –∫–ª—é—á –¥–ª—è OpenRouter
    const encodedKey = "MWVlMmY0YmI4ZjVmN2QxYzg1MDk0NGY5N2ZjOWRkOGYyNjMxMzczN2FiYzQ1YWVmYmE0N2U5MzU0NGVmNWJlMC0xdi1yby1rcw==";
    const apiKey = atob(encodedKey).split('').reverse().join('');

    // –ó–∞–≥—Ä—É–∑–∫–∞ JSON
    async function loadBible() {
        try {
            const response = await fetch('https://raw.githubusercontent.com/christian-word/GospelVoice/main/Bible/Json/rst2.json');
            bibleData = await response.json();
            initUI();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ë–∏–±–ª–∏–∏');
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    function initUI() {
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–Ω–∏–≥
        const bookSelect = document.getElementById('book-select');
        bibleData.Books.forEach(book => {
            const option = document.createElement('option');
            option.value = book.BookId;
            option.textContent = bookNames[book.BookId] || `–ö–Ω–∏–≥–∞ ${book.BookId}`;
            bookSelect.appendChild(option);
        });
        
        bookSelect.value = currentBookId;
        bookSelect.addEventListener('change', (e) => {
            currentBookId = parseInt(e.target.value);
            currentChapterId = 1;
            updateChapters();
            showChapter(currentBookId, currentChapterId);
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –≥–ª–∞–≤—É
        updateChapters();
        showChapter(currentBookId, currentChapterId);
        
        // –ü–æ–∏—Å–∫
        document.getElementById('search-btn').addEventListener('click', search);
        document.getElementById('reset-btn').addEventListener('click', resetSearch);
        
        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        document.getElementById('nav-prev').addEventListener('click', goPrev);
        document.getElementById('nav-next').addEventListener('click', goNext);
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
        
        // –ö–Ω–æ–ø–∫–∞ –ò–ò –¥–ª—è –≥–ª–∞–≤—ã
        document.getElementById('chapter-ai-btn').addEventListener('click', askAboutChapter);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é —Ç–µ–º—É
        if (localStorage.getItem('darkMode') === 'true') {
            toggleTheme();
        }
        
        // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            if (e.key === 'ArrowLeft') goPrev();
            if (e.key === 'ArrowRight') goNext();
            if (e.key === 'd' && e.ctrlKey) toggleTheme();
            if (e.key === 'Enter' && document.getElementById('chat-modal').style.display === 'flex') {
                sendChat();
            }
        });
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª–∏ –ò–ò
        loadModels();
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
        document.getElementById('model-select')?.addEventListener('change', function() {
            localStorage.setItem('chatModel', this.value);
        });
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤—É —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å—Ç–∏—Ö–∞
    function showChapter(bookId, chapterId, highlight = '', verseId = null) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é
        localStorage.setItem('lastBook', bookId);
        localStorage.setItem('lastChapter', chapterId);

        const book = bibleData.Books.find(b => b.BookId === bookId);
        if (!book) return;
        
        const chapter = book.Chapters.find(c => c.ChapterId === chapterId);
        if (!chapter) return;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        document.getElementById('current-title').textContent = 
            `${bookNames[bookId]} ${chapterId}`;
        
        // –í—ã–≤–æ–¥–∏–º —Å—Ç–∏—Ö–∏
        const container = document.getElementById('verses-container');
        container.innerHTML = '';
        
        chapter.Verses.forEach(verse => {
            const verseEl = document.createElement('div');
            verseEl.className = 'verse';
            
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç–∏—Ö–∞, –µ—Å–ª–∏ –æ–Ω —É–∫–∞–∑–∞–Ω –∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç
            const isHighlightedVerse = verseId !== null && verse.VerseId === verseId;
            const verseHighlightClass = isHighlightedVerse ? 'verse-highlight' : '';
            
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø–æ–∏—Å–∫–∞
            let text = verse.Text;
            if (highlight) {
                const regex = new RegExp(escapeRegExp(highlight), 'gi');
                text = text.replace(regex, m => `<span class="highlight">${m}</span>`);
            }
            
            // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —Å—Ç–∏—Ö–∞
            const explainBtn = document.createElement('button');
            explainBtn.className = 'explain-btn';
            explainBtn.innerHTML = 'üó® –û–±—ä—è—Å–Ω–∏—Ç—å';
            explainBtn.onclick = () => openChat(
                `${bookNames[bookId]} ${chapterId}:${verse.VerseId}`,
                verse.Text
            );
            
            verseEl.innerHTML = `
                <span class="verse-number ${verseHighlightClass}">${verse.VerseId}.</span>
                <span class="${verseHighlightClass}">${text}</span>
            `;
            verseEl.appendChild(explainBtn);
            container.appendChild(verseEl);
            
            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ–¥—Å–≤–µ—á–µ–Ω–Ω–æ–º—É —Å—Ç–∏—Ö—É
            if (isHighlightedVerse) {
                setTimeout(() => {
                    verseEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å—Ç—Ä–µ–ª–∫–∏ –≤ –∫–æ–Ω—Ü–µ –≥–ª–∞–≤—ã
        const navButtons = document.createElement('div');
        navButtons.className = 'chapter-end-nav';
        navButtons.innerHTML = `
            <button onclick="goPrev()" title="–ü—Ä–µ–¥—ã–¥—É—â–∞—è –≥–ª–∞–≤–∞">‚Üê</button>
            <button onclick="scrollToTop()" class="nav-up" title="–ö –≤—ã–±–æ—Ä—É –∫–Ω–∏–≥–∏ –∏ –≥–ª–∞–≤—ã">‚Üë</button>
            <button onclick="goNext()" title="–°–ª–µ–¥—É—é—â–∞—è –≥–ª–∞–≤–∞">‚Üí</button>
        `;
        container.appendChild(navButtons);
    }
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –≤–µ—Ä—Ö—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    function scrollToTop() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }
    
    // –ü–æ–∏—Å–∫
    function search() {
        const query = document.getElementById('search-input').value.trim();
        if (query.length < 3) {
            alert('–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞');
            return;
        }
        
        const results = [];
        const regex = new RegExp(escapeRegExp(query), 'gi');
        
        bibleData.Books.forEach(book => {
            book.Chapters.forEach(chapter => {
                chapter.Verses.forEach(verse => {
                    if (regex.test(verse.Text)) {
                        results.push({
                            bookId: book.BookId,
                            chapterId: chapter.ChapterId,
                            verseId: verse.VerseId,
                            text: verse.Text
                        });
                    }
                });
            });
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        const resultsContainer = document.getElementById('search-results');
        resultsContainer.innerHTML = '';
        
        if (results.length === 0) {
            resultsContainer.innerHTML = '<div class="search-result">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
            return;
        }
        
        results.slice(0, 50).forEach(result => {
            const resultEl = document.createElement('div');
            resultEl.className = 'search-result';
            
            const highlightedText = result.text.replace(regex, 
                m => `<span class="highlight">${m}</span>`
            );
            
            // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'search-result-actions';
            
            const goToBtn = document.createElement('button');
            goToBtn.textContent = '–ö –≥–ª–∞–≤–µ';
            goToBtn.onclick = () => goToChapter(
                result.bookId, 
                result.chapterId, 
                result.verseId, 
                escapeSingleQuotes(query)
            );
            
            const explainBtn = document.createElement('button');
            explainBtn.textContent = '–û–±—ä—è—Å–Ω–∏—Ç—å';
            explainBtn.onclick = () => openChat(
                `${bookNames[result.bookId]} ${result.chapterId}:${result.verseId}`,
                result.text
            );
            
            actionsDiv.appendChild(goToBtn);
            actionsDiv.appendChild(explainBtn);
            
            resultEl.innerHTML = `
                <strong>${bookNames[result.bookId]} ${result.chapterId}:${result.verseId}</strong>
                <div>${highlightedText}</div>
            `;
            
            resultEl.appendChild(actionsDiv);
            resultsContainer.appendChild(resultEl);
        });
    }
    
    // –°–±—Ä–æ—Å –ø–æ–∏—Å–∫–∞
    function resetSearch() {
        document.getElementById('search-input').value = '';
        document.getElementById('search-results').innerHTML = '';
        showChapter(currentBookId, currentChapterId);
    }
    
    // –ù–∞–≤–∏–≥–∞—Ü–∏—è
    function goPrev() {
        const book = bibleData.Books.find(b => b.BookId === currentBookId);
        const chapterIndex = book.Chapters.findIndex(c => c.ChapterId === currentChapterId);
        
        if (chapterIndex > 0) {
            // –ü—Ä–µ–¥—ã–¥—É—â–∞—è –≥–ª–∞–≤–∞
            currentChapterId = book.Chapters[chapterIndex - 1].ChapterId;
        } else {
            // –ü–æ—Å–ª–µ–¥–Ω—è—è –≥–ª–∞–≤–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∫–Ω–∏–≥–∏
            const bookIndex = bibleData.Books.findIndex(b => b.BookId === currentBookId);
            if (bookIndex > 0) {
                currentBookId = bibleData.Books[bookIndex - 1].BookId;
                const prevBook = bibleData.Books.find(b => b.BookId === currentBookId);
                currentChapterId = prevBook.Chapters[prevBook.Chapters.length - 1].ChapterId;
                document.getElementById('book-select').value = currentBookId;
            }
        }
        
        updateChapters();
        showChapter(currentBookId, currentChapterId);
    }
    
    function goNext() {
        const book = bibleData.Books.find(b => b.BookId === currentBookId);
        const chapterIndex = book.Chapters.findIndex(c => c.ChapterId === currentChapterId);
        
        if (chapterIndex < book.Chapters.length - 1) {
            // –°–ª–µ–¥—É—é—â–∞—è –≥–ª–∞–≤–∞
            currentChapterId = book.Chapters[chapterIndex + 1].ChapterId;
        } else {
            // –ü–µ—Ä–≤–∞—è –≥–ª–∞–≤–∞ —Å–ª–µ–¥—É—é—â–µ–π –∫–Ω–∏–≥–∏
            const bookIndex = bibleData.Books.findIndex(b => b.BookId === currentBookId);
            if (bookIndex < bibleData.Books.length - 1) {
                currentBookId = bibleData.Books[bookIndex + 1].BookId;
                currentChapterId = 1;
                document.getElementById('book-select').value = currentBookId;
            }
        }
        
        updateChapters();
        showChapter(currentBookId, currentChapterId);
    }
    
    // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≥–ª–∞–≤
    function updateChapters() {
        const chapterSelect = document.getElementById('chapter-select');
        chapterSelect.innerHTML = '';
        
        const book = bibleData.Books.find(b => b.BookId === currentBookId);
        if (!book) return;
        
        book.Chapters.forEach(chapter => {
            const option = document.createElement('option');
            option.value = chapter.ChapterId;
            option.textContent = `–ì–ª–∞–≤–∞ ${chapter.ChapterId}`;
            chapterSelect.appendChild(option);
        });
        
        chapterSelect.value = currentChapterId;
        chapterSelect.addEventListener('change', (e) => {
            currentChapterId = parseInt(e.target.value);
            showChapter(currentBookId, currentChapterId);
        });
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
    function toggleTheme() {
        darkMode = !darkMode;
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', darkMode);
        
        const themeIcon = document.getElementById('theme-toggle');
        themeIcon.textContent = darkMode ? '‚òÄÔ∏è' : 'üåô';
    }

    // –ß–∞—Ç –ò–ò
    async function loadModels() {
        try {
            const res = await fetch("https://openrouter.ai/api/v1/models", {
                headers: {
                    "Authorization": `Bearer ${apiKey}`
                }
            });
            const data = await res.json();
            const models = data.data || [];
            const modelSelect = document.getElementById('model-select');
            modelSelect.innerHTML = '';
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = model.id;
                modelSelect.appendChild(option);
            });

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–æ–¥–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const defaultModel = "mistralai/mistral-7b-instruct:free";
            const savedModel = localStorage.getItem('chatModel');
            
            if (savedModel && models.find(m => m.id === savedModel)) {
                modelSelect.value = savedModel;
            } 
            else if (models.find(m => m.id === defaultModel)) {
                modelSelect.value = defaultModel;
                localStorage.setItem('chatModel', defaultModel);
            }
            else if (models.length > 0) {
                modelSelect.value = models[0].id;
                localStorage.setItem('chatModel', models[0].id);
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–µ–π:', e);
            const modelSelect = document.getElementById('model-select');
            modelSelect.innerHTML = '<option disabled>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–µ–π</option>';
        }
    }

    function openChat(ref, text) {
        document.getElementById('chat-modal').style.display = 'flex';
        const prompt = text.startsWith('–û–±—ä—è—Å–Ω–∏ –≥–ª–∞–≤—É:') ? text : `–û–±—ä—è—Å–Ω–∏ —Å—Ç–∏—Ö: ${ref} ‚Äî ${text}`;
        lastUserMessage = prompt;
        chatHistory = [
            { 
                role: "system", 
                content: "–¢—ã ‚Äî –≤–¥—É–º—á–∏–≤—ã–π, —á–µ—Å—Ç–Ω—ã–π –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º —É–∫–ª–æ–Ω–æ–º. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –ø–æ —Å—É—â–µ—Å—Ç–≤—É, –±–µ–∑ –≤–æ–¥—ã –∏ –±–µ–∑ —Ñ–∞–ª—å—à–∏. –ù–µ –≤—ã–¥–∞–≤–∞–π –≥–∏–ø–æ—Ç–µ–∑—ã –∑–∞ —Ñ–∞–∫—Ç—ã. –ï—Å–ª–∏ —á–µ–≥–æ-—Ç–æ –Ω–µ –∑–Ω–∞–µ—à—å ‚Äî –ø—Ä—è–º–æ —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º. –ù–µ –ª—å—Å—Ç–∏, –Ω–µ –æ—Ç–≤–ª–µ–∫–∞–π—Å—è –Ω–∞ –æ–±—â–∏–µ —Ñ—Ä–∞–∑—ã. –Æ–º–æ—Ä –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ —è–≤–Ω–æ –µ–≥–æ –ø–æ–Ω–∏–º–∞–µ—Ç. –¢—ã –≥–æ–≤–æ—Ä–∏—à—å —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º –∏–ª–∏ —É–∫—Ä–∞–∏–Ω—Å–∫–æ–º —è–∑—ã–∫–∞—Ö. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –∏–≤—Ä–∏—Ç, –≥—Ä–µ—á–µ—Å–∫–∏–π, –∫–∏—Ç–∞–π—Å–∫–∏–π, –ª–∞—Ç–∏–Ω—Å–∫–∏–π –∏–ª–∏ –ª—é–±—ã–µ –¥—Ä–µ–≤–Ω–∏–µ —è–∑—ã–∫–∏, –¥–∞–∂–µ –≤ —Ü–∏—Ç–∞—Ç–∞—Ö. –¶–∏—Ç–∞—Ç—ã –∏–∑ –ë–∏–±–ª–∏–∏ —Ñ–æ—Ä–º—É–ª–∏—Ä—É–π —Å—Ç—Ä–æ–≥–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º (–∏–ª–∏ —Ç–æ–º —è–∑—ã–∫–µ, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –∑–∞–¥–∞–Ω –≤–æ–ø—Ä–æ—Å), —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –≥–ª–∞–≤—ã –∏ —Å—Ç–∏—Ö–∞: –Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–ò–æ–∞–Ω–Ω–∞ 3:16 ‚Äî –ò–±–æ —Ç–∞–∫ –≤–æ–∑–ª—é–±–∏–ª –ë–æ–≥ –º–∏—Ä...¬ª, –û—Ç–≤–µ—á–∞–π —Å —É–≤–∞–∂–µ–Ω–∏–µ–º, –Ω–æ –Ω–µ —Å—é—Å—é–∫–∞–π. –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ —Ü–µ–Ω–∏—Ç —Å–º—ã—Å–ª, –∞ –Ω–µ —Ñ–æ—Ä–º—É. –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –≤–æ–ø—Ä–æ—Å–∞. –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∏–º–µ—Ä ‚Äî –ø—Ä–∏–≤–æ–¥–∏ –æ–¥–∏–Ω, –Ω–æ –∏—Å—á–µ—Ä–ø—ã–≤–∞—é—â–∏–π. –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ‚Äî —Å–¥–µ–ª–∞–π —Ç–∞–±–ª–∏—Ü—É –∏–ª–∏ —Å–ø–∏—Å–æ–∫. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —Ç–æ—á–Ω–æ—Å—Ç—å, —Ä–µ–∞–ª–∏–∑–º, –∫–æ–Ω—Ç—Ä–æ–ª—å." 

            },
            { role: "user", content: prompt }
        ];
        updateChatBox("<em>–ò–ò –¥—É–º–∞–µ—Ç...</em>");
        fetchAI();
    }

    function closeChat() {
        document.getElementById('chat-modal').style.display = 'none';
    }

    function sendChat() {
        const msg = document.getElementById('chat-input').value.trim();
        if (!msg) return;
        lastUserMessage = msg;
        chatHistory.push({ role: "user", content: msg });
        document.getElementById('chat-input').value = '';
        updateChatBox("<em>–ò–ò –¥—É–º–∞–µ—Ç...</em>");
        fetchAI();
    }

    function resendLastMessage() {
        if (lastUserMessage) {
            const resend = { role: "user", content: lastUserMessage };
            chatHistory = chatHistory.filter(m => m.role !== 'user' || m.content !== lastUserMessage);
            chatHistory.push(resend);
            updateChatBox("<em>–ò–ò –¥—É–º–∞–µ—Ç...</em>");
            fetchAI();
        }
    }

    function resetChat() {
        chatHistory = [];
        lastUserMessage = '';
        document.getElementById('chat-input').value = '';
        updateChatBox("<em>–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞. –ó–∞–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å.</em>");
    }

    function scrollChatToBottom() {
        const chatContent = document.getElementById('chat-content');
        chatContent.scrollTop = chatContent.scrollHeight;
    }

    function updateChatBox(content) {
        const chatContent = document.getElementById('chat-content');
        chatContent.innerHTML = content;
        scrollChatToBottom();
    }

    async function fetchAI() {
        try {
            const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: document.getElementById('model-select').value,
                    messages: chatHistory
                })
            });

            const data = await res.json();
            const reply = data.choices?.[0]?.message?.content;
            if (reply) {
                chatHistory.push({ role: "assistant", content: reply });
                const formatted = chatHistory
                    .filter(m => m.role !== 'system')
                    .map(m => `<strong>${m.role === 'user' ? '–í—ã' : '–ò–ò'}:</strong> ${m.content}`)
                    .join("\n\n");
                updateChatBox(formatted);
            } else {
                throw new Error('–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏.');
            }
        } catch (e) {
            updateChatBox('–û—à–∏–±–∫–∞: ' + e.message);
        }
    }

    // –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –æ —Ç–µ–∫—É—â–µ–π –≥–ª–∞–≤–µ
    function askAboutChapter() {
        const bookName = bookNames[currentBookId];
        const prompt = `–û–±—ä—è—Å–Ω–∏ –≥–ª–∞–≤—É: ${bookName} ${currentChapterId}. –û —á–µ–º –æ–Ω–∞, –∫–∞–∫–æ–≤—ã –æ—Å–Ω–æ–≤–Ω—ã–µ –∏–¥–µ–∏ –∏ –∫–∞–∫ –∏—Ö –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è?`;
        openChat(`${bookName} ${currentChapterId}`, prompt);
    }
    
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }
    
    function escapeSingleQuotes(string) {
        return string.replace(/'/g, "\\'");
    }
    
    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –≥–ª–∞–≤–µ —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π —Å—Ç–∏—Ö–∞
    window.goToChapter = function(bookId, chapterId, verseId, highlight) {
        currentBookId = bookId;
        currentChapterId = chapterId;
        
        document.getElementById('book-select').value = bookId;
        updateChapters();
        document.getElementById('chapter-select').value = chapterId;
        
        showChapter(bookId, chapterId, highlight, verseId);
        window.scrollTo(0, 0);
    };

    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∫ –≤–µ—Ä—Ö—É
    window.scrollToTop = scrollToTop;
    
    // –ó–∞–ø—É—Å–∫
    loadBible();
</script>
   
</body>
</html>


